
[gcode_macro _SET_TIMELAPSE_SETUP]
gcode:
  RESPOND MSG="_SET_TIMELAPSE_SETUP: ok"

[gcode_macro HYPERLAPSE]
gcode:
  RESPOND MSG="HYPERLAPSE: ok"

[gcode_macro RESUME]
description: Resume print (stock)
rename_existing: RESUME_BASE
gcode:
  RESUME_BASE

[delayed_gcode __RESUME_WAIT_KLICKY_REMOVED]
initial_duration: 0
gcode:
  ; no-op (kept for compatibility)

[gcode_macro_break]

# QIDI/QidiSlicer pause compatibility
[gcode_macro M0]
description: QIDI pause (maps to Klipper PAUSE)
gcode:
  PAUSE

[gcode_macro M601]
description: QidiSlicer "Pause print" (maps to Klipper PAUSE)
gcode:
  PAUSE

[gcode_macro M602]
description: QidiSlicer resume after M601 (maps to Klipper RESUME)
gcode:
  RESUME

[mcu]
serial: /dev/ttyS2
restart_method: command

[mcu U_1]
serial: /dev/ttyS0
restart_method: command

[temperature_sensor CPU]
sensor_type: temperature_host
min_temp: 0
max_temp: 90

[temperature_sensor Motherboard_MCU]
sensor_type: temperature_mcu
sensor_mcu: U_1
min_temp: 0
max_temp: 90

[temperature_sensor Printhead_MCU]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 120

[respond]
default_type: echo

[force_move]
enable_force_move: true

[hall_filament_width_sensor]
adc1: gpio27
adc2: gpio28
cal_dia1: 1.50
cal_dia2: 2.0
raw_dia1: 14397
raw_dia2: 15058
default_nominal_filament_diameter: 1.75
max_difference: 0
measurement_delay: 50
enable: False
measurement_interval: 10
logging: False
min_diameter: 0.3
use_current_dia_while_delay: False
pause_on_runout: True
runout_gcode:
  RESET_FILAMENT_WIDTH_SENSOR
  M118 Filament run out
event_delay: 3.0
pause_delay: 0.5

[printer]
kinematics: corexy
max_velocity: 600
max_accel: 4300
max_accel_to_decel: 4300
max_z_velocity: 5
max_z_accel: 200

[extruder]
step_pin: gpio5
dir_pin: gpio4
enable_pin: !gpio10
rotation_distance: 53.7
gear_ratio: 1517:170
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
min_temp: 0
max_temp: 360
min_extrude_temp: 175
smooth_time: 0.000001
heater_pin: gpio24
sensor_type: MAX6675
sensor_pin: gpio17
spi_speed: 100000
spi_software_sclk_pin: gpio18
spi_software_mosi_pin: gpio19
spi_software_miso_pin: gpio16
max_power: 1
control: pid
pid_Kp: 39.961
pid_Ki: 4.638
pid_Kd: 81.818
pressure_advance: 0
pressure_advance_smooth_time: 0.02
max_extrude_cross_section: 500
instantaneous_corner_velocity: 10.000
max_extrude_only_distance: 1000.0
max_extrude_only_velocity: 5000
max_extrude_only_accel: 5000
step_pulse_duration: 0.000002

[tmc2209 extruder]
uart_pin: gpio6
interpolate: False
run_current: 0.714
stealthchop_threshold: 0

[adxl345]
cs_pin: gpio13
spi_software_sclk_pin: gpio14
spi_software_mosi_pin: gpio15
spi_software_miso_pin: gpio12
axes_map: -x, z, -y

[stepper_x]
step_pin: U_1:PB4
dir_pin: !U_1:PB3
enable_pin: !U_1:PB5
microsteps: 16
rotation_distance: 39.98
full_steps_per_rotation: 200
endstop_pin: tmc2240_stepper_x:virtual_endstop
position_min: -5.5
position_endstop: -5.5
position_max: 246
homing_speed: 50
homing_retract_dist: 0


[stepper_y]
step_pin: U_1:PC14
dir_pin: !U_1:PC13
enable_pin: !U_1:PC15
microsteps: 16
rotation_distance: 39.98
full_steps_per_rotation: 200
endstop_pin: tmc2240_stepper_y:virtual_endstop
position_min: -4.5
position_endstop: -4.5
position_max: 258
homing_speed: 50
homing_retract_dist: 0

[stepper_z]
step_pin: U_1:PC10
dir_pin: U_1:PA15
enable_pin: !U_1:PC11
microsteps: 16
rotation_distance: 4
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
endstop_pin_reverse: tmc2209_stepper_z:virtual_endstop
position_endstop_reverse: 240
position_max: 240
position_min: -5
homing_speed: 10
homing_speed_reverse: 10
homing_retract_dist: 0.0
homing_positive_dir: false
homing_positive_dir_reverse: true

[stepper_z1]
step_pin: U_1:PB1
dir_pin: U_1:PB6
enable_pin: !U_1:PB0
microsteps: 16
rotation_distance: 4
endstop_pin_reverse: tmc2209_stepper_z1:virtual_endstop

[tmc2240 stepper_y]
cs_pin: U_1:PB9
spi_software_sclk_pin: U_1:PA5
spi_software_mosi_pin: U_1:PA7
spi_software_miso_pin: U_1:PA6
spi_speed: 200000
run_current: 1.07
interpolate: False
stealthchop_threshold: 0
diag0_pin: !U_1:PC0
driver_SGT: 1

[tmc2240 stepper_x]
cs_pin: U_1:PD2
spi_software_sclk_pin: U_1:PA5
spi_software_mosi_pin: U_1:PA7
spi_software_miso_pin: U_1:PA6
spi_speed: 200000
run_current: 1.07
interpolate: False
stealthchop_threshold: 0
diag0_pin: !U_1:PB8
driver_SGT: 1

[tmc2209 stepper_z]
uart_pin: U_1:PC5
run_current: 0.6
interpolate: True
stealthchop_threshold: 9999999999
diag_pin: ^U_1:PC12
driver_SGTHRS: 130

[tmc2209 stepper_z1]
uart_pin: U_1:PB7
run_current: 0.6
interpolate: True
stealthchop_threshold: 9999999999
diag_pin: ^U_1:PA13
driver_SGTHRS: 130

[heater_bed]
heater_pin: U_1:PB10
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: U_1:PA0
max_power: 1.0
control: pid
pid_Kp: 74.233
pid_Ki: 1.576
pid_Kd: 874.089
min_temp: 0
max_temp: 135

[heater_generic chamber]
heater_pin: U_1:PC8
max_power: 1.0
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: U_1:PA1
control: pid
pid_Kp: 59.258
pid_Ki: 0.510
pid_Kd: 1719.976
min_temp: 0
max_temp: 90

[verify_heater chamber]
max_error: 5000000
check_gain_time: 10000000
hysteresis: 5
heating_gain: 1

[verify_heater extruder]
max_error: 120
check_gain_time: 20
hysteresis: 5
heating_gain: 1

[verify_heater heater_bed]
max_error: 200
check_gain_time: 60
hysteresis: 5
heating_gain: 1

[fan_generic auxiliary_cooling_fan]
pin: U_1:PA8
shutdown_speed: 0.0
cycle_time: 0.0100
hardware_pwm: false
kick_start_time: 0.100
off_below: 0.0

[chamber_fan chamber_fan]
pin: U_1:PA4
max_power: 1.0
shutdown_speed: 0
kick_start_time: 0.5
heater: chamber
fan_speed: 1.0
off_below: 0
idle_timeout: 60
idle_speed: 1.0

[heater_fan hotend_fan]
pin: gpio25
max_power: 1.0
shutdown_speed: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
fan_speed: 1.0
off_below: 0

[heater_fan mainboard_fan]
pin: U_1:PC9
heater: chamber
heater_temp: 40.0
fan_speed: 1.0
kick_start_time: 0.5
shutdown_speed: 0
max_power: 1.0

[controller_fan board_fan]
pin: U_1:PC4
max_power: 1.0
shutdown_speed: 1.0
cycle_time: 0.01
fan_speed: 0.6
stepper: stepper_x,stepper_y,stepper_z,stepper_z1
heater: extruder,heater_bed,chamber

[fan]
pin: gpio2
max_power: 1.0
shutdown_speed: 0
cycle_time: 0.0100
hardware_pwm: false
kick_start_time: 0.100
off_below: 0.0

[output_pin caselight]
pin: U_1:PC7
pwm: false
shutdown_value: 1
value: 1

[output_pin beeper]
pin: U_1:PA2
pwm: false
shutdown_value: 0
value: 0

[output_pin ctlyd]
pin: U_1:PA14
pwm: false
shutdown_value: 0
value: 0

[screws_tilt_adjust]
horizontal_move_z: 10
screw1: -5,-3
screw1_name: Front left
screw2: 200,-3
screw2_name: Front right
screw3: 100,210
screw3_name: Last right
screw_thread: CW-M4
speed: 300

[probe]
pin: ^gpio21
x_offset: 21.41
y_offset: 13.67
z_offset: 5.3
speed: 5
samples: 3
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.1
samples_tolerance_retries: 2
deactivate_on_each_sample: false

[output_pin probe_enable]
pin: gpio11
value: 1

[gcode_macro probe_deploy]
gcode:
  SET_PIN PIN=probe_enable VALUE=0

[gcode_macro probe_stow]
gcode:
  SET_PIN PIN=probe_enable VALUE=1

[bed_mesh]
speed: 300
horizontal_move_z: 6
mesh_min: 17,13
mesh_max: 232,232
probe_count: 8,8
algorithm: bicubic
bicubic_tension: 0.2
mesh_pps: 2,2

[z_tilt]
horizontal_move_z: 8
z_positions:
  -60,122.5
  305,122.5
points:
  -1.4,108.8
  200,108.8
speed: 300

[filament_switch_sensor filament_tangle_sensor]
pause_on_runout: True
runout_gcode:
  M118 Filament tangle detected
event_delay: 3.0
pause_delay: 0.5
switch_pin: U_1:PC3

[resonance_tester]
accel_chip: adxl345
probe_points:
  122.5,122.5,10

[idle_timeout]
timeout: 43200

[pause_resume]
[display_status]

[virtual_sdcard]
path: ~/gcode_files

[exclude_object]

[input_shaper]
shaper_type_x: ei
shaper_freq_x: 58
shaper_type_y: zv
shaper_freq_y: 45.6

[gcode_arcs]
resolution: 1.0


[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
description: Cancel print safely
gcode:
  M118 CANCEL_PRINT: requested
  CLEAR_PAUSE

  # Break temperature waits (M190/M109/TEMPERATURE_WAIT)
  TURN_OFF_HEATERS

  # Fans off
  M107
  SET_FAN_SPEED FAN=auxiliary_cooling_fan SPEED=0.0

  # Stop virtual SD print if active
  {% if printer.virtual_sdcard.is_active|default(False) %}
    SDCARD_RESET_FILE
  {% endif %}

  # Park if homed
  {% if "xyz" in printer.toolhead.homed_axes %}
    G91
    G1 Z10 F600
    G90
    G1 X30 Y30 F6000
  {% endif %}

  M84
  CANCEL_PRINT_BASE

[gcode_macro PAUSE]
description: Pause and park
rename_existing: PAUSE_BASE
variable_extrude: 1.0
gcode:
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  {% set xmin = printer.toolhead.axis_minimum.x|float %}
  {% set ymin = printer.toolhead.axis_minimum.y|float %}
  {% set x_park = (xmin + 40.0)|round(1) %}
  {% set y_park = (ymin + 25.0)|round(1) %}
  {% set zmax  = printer.toolhead.axis_maximum.z|float %}
  {% set curz  = printer.toolhead.position.z|float %}
  {% set margin = 0.5 %}
  {% set want = 10.0 %}
  {% set drop = 15.0 %}
  {% set total = want + drop %}
  {% set allow = [total, (zmax - curz - margin)]|min %}

  PAUSE_BASE
  G91
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F2100
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    {% if allow > 0 %} G1 Z{allow|round(2)} F900 {% endif %}
    G90
    G1 X{x_park} Y{y_park} F6000
  {% endif %}


[gcode_macro M191]
gcode:
  {% set s = params.S|float %}
  {% if s == 0 %}
    M117 Chamber heating cancelled
  {% else %}
    SET_HEATER_TEMPERATURE HEATER=chamber TARGET={s}
    M140 S120
    TEMPERATURE_WAIT SENSOR="heater_generic chamber" MINIMUM={s-10} MAXIMUM={s+1}
    M117 Chamber at target temperature
  {% endif %}

[gcode_macro M141]
gcode:
  {% set s = params.S|float %}
  {% if s == 0 %}
    M117 Chamber heating cancelled
  {% else %}
    M117 Heating chamber (no wait)
    SET_HEATER_TEMPERATURE HEATER=chamber TARGET={s}
  {% endif %}

[gcode_macro M8029]
gcode:
  {% if params.D is defined %}
    {% if (params.D|int)==1 %}
      ENABLE_FILAMENT_WIDTH_SENSOR
    {% endif %}
    {% if (params.D|int)==0 %}
      DISABLE_FILAMENT_WIDTH_SENSOR
    {% endif %}
  {% endif %}

[gcode_macro M900]
gcode:
  {% if params.K is defined %}
    SET_PRESSURE_ADVANCE ADVANCE={params.K}
  {% endif %}
  {% if params.T is defined %}
    SET_PRESSURE_ADVANCE SMOOTH_TIME={params.T}
  {% endif %}

[gcode_macro M603]
description: Unload filament
gcode:
  M118 Heat up complete
  G92 E0
  G0 E15 F400
  G4 P1000
  G92 E0
  G1 E-90 F800
  M400
  M118 Filament unloaded

[gcode_macro M604]
description: Load filament
gcode:
  M118 Heat up complete
  M83
  G1 E80 F400
  M400
  M118 Filament loaded

[gcode_macro M303]
gcode:
  {% if params.E is defined and params.S is defined %}
    {% if (params.E|int)==-1 %}
      PID_CALIBRATE HEATER=heater_bed TARGET={params.S|int}
    {% endif %}
    {% if (params.E|int)==0 %}
      PID_CALIBRATE HEATER=extruder TARGET={params.S|int}
    {% endif %}
  {% endif %}

# =====================================================================
# KLICKY (QIDI Q1 Pro)
# - Probe logic: OPEN = probe on head (not pressed), TRIGGERED = probe missing/docked/pressed.
# - Endstop state is refreshed using QUERY_* first, then read on the next macro line.
# - Homing flow: G28 -> home XY -> attach if missing -> home Z at center -> Z_TILT_ADJUST -> home Z again.
# =====================================================================

[gcode_macro KLICKY_CFG]
description: Klicky geometry and tuning
# Do not change these unless you re-measured the dock
variable_dock_x:     94.21
variable_dock_y:     253.5
variable_approach_x: 94.21
variable_approach_y: 235
variable_pull_x:     69.21
variable_pull_y:     253.5
variable_clear_x:    69.21
variable_clear_y:    235

# Optional micro-push into the dock (improves pickup/release)
variable_push_x:     0.0
variable_push_y:     1.0
variable_dwell_ms:   250

# Fallback offset (used only if pickup fails at the primary coordinates)
variable_fallback_dx: 1.10
variable_fallback_dy: 9.00

# Motion
variable_safe_z:     10.0
variable_travel_f:   6000
variable_dock_f:     2400
gcode:
  ; no-op

[gcode_macro _KLICKY_FORCE_LIFT]
description: Lift Z a bit before long XY moves
gcode:
  {% set cfg = printer["gcode_macro KLICKY_CFG"] %}
  {% if "z" in printer.toolhead.homed_axes %}
    {% set curz = printer.toolhead.position.z|float %}
    {% set safe = cfg.safe_z|float %}
    {% if curz < safe %}
      G91
      G1 Z{(safe-curz)|round(3)} F600
      G90
    {% endif %}
  {% endif %}

[gcode_macro _KLICKY_REFRESH_ENDSTOPS]
description: Refresh probe/endstop status (read it in the NEXT macro line)
gcode:
  QUERY_PROBE
  QUERY_ENDSTOPS

[gcode_macro _KLICKY_ASSERT_OPEN]
description: Error if Z endstop is TRIGGERED
gcode:
  {% set z = (printer.query_endstops.last_query.z|default("unknown"))|string|lower %}
  {% if z in ["open","0","false"] %}
    ; ok
  {% elif z in ["triggered","1","true"] %}
    {action_raise_error("KLICKY: probe is TRIGGERED (missing/docked/pressed)")}
  {% else %}
    {action_raise_error("KLICKY: probe state UNKNOWN: " ~ z)}
  {% endif %}

[gcode_macro _KLICKY_ASSERT_TRIG]
description: Error if Z endstop is not TRIGGERED
gcode:
  {% set z = (printer.query_endstops.last_query.z|default("unknown"))|string|lower %}
  {% if z in ["triggered","1","true"] %}
    ; ok
  {% elif z in ["open","0","false"] %}
    {action_raise_error("KLICKY: expected TRIGGERED after docking, got OPEN")}
  {% else %}
    {action_raise_error("KLICKY: probe state UNKNOWN: " ~ z)}
  {% endif %}

[gcode_macro _KLICKY_DIAG_PRINT]
gcode:
  {% set z = (printer.query_endstops.last_query.z|default("unknown"))|string %}
  {action_respond_info("KLICKY_DIAG: z=" ~ z ~ " | probe.last_query=" ~ (printer.probe.last_query|string))}

[gcode_macro KLICKY_DIAG]
description: Print current probe/endstop state
gcode:
  _KLICKY_REFRESH_ENDSTOPS
  _KLICKY_DIAG_PRINT

[gcode_macro _KLICKY_ATTACH_ATTEMPT_PRIMARY]
gcode:
  {% set c = printer["gcode_macro KLICKY_CFG"] %}
  G90
  G0 X{c.approach_x} Y{c.approach_y} F{c.travel_f}
  G0 X{c.dock_x}     Y{c.dock_y}     F{c.travel_f}
  {% if (c.push_x|float != 0.0) or (c.push_y|float != 0.0) %}
    G0 X{(c.dock_x + c.push_x)|round(3)} Y{(c.dock_y + c.push_y)|round(3)} F{c.dock_f}
  {% endif %}
  G4 P{c.dwell_ms}
  G0 X{c.approach_x} Y{c.approach_y} F{c.dock_f}
  M400
  G4 P120

[gcode_macro _KLICKY_ATTACH_ATTEMPT_FALLBACK]
gcode:
  {% set c = printer["gcode_macro KLICKY_CFG"] %}
  {% set dx = c.fallback_dx|float %}
  {% set dy = c.fallback_dy|float %}
  G90
  G0 X{(c.approach_x+dx)|round(3)} Y{(c.approach_y+dy)|round(3)} F{c.travel_f}
  G0 X{(c.dock_x+dx)|round(3)}     Y{(c.dock_y+dy)|round(3)}     F{c.travel_f}
  {% if (c.push_x|float != 0.0) or (c.push_y|float != 0.0) %}
    G0 X{(c.dock_x+dx+c.push_x)|round(3)} Y{(c.dock_y+dy+c.push_y)|round(3)} F{c.dock_f}
  {% endif %}
  G4 P{c.dwell_ms}
  G0 X{(c.approach_x+dx)|round(3)} Y{(c.approach_y+dy)|round(3)} F{c.dock_f}
  M400
  G4 P120

[gcode_macro _KLICKY_ATTACH_VERIFY]
gcode:
  {% set z = (printer.query_endstops.last_query.z|default("unknown"))|string|lower %}
  {% if z in ["open","0","false"] %}
    {action_respond_info("KLICKY_ATTACH done")}
  {% elif z in ["triggered","1","true"] %}
    {action_respond_info("KLICKY_ATTACH: still TRIGGERED, retry with fallback offset")}
    _KLICKY_ATTACH_ATTEMPT_FALLBACK
    _KLICKY_REFRESH_ENDSTOPS
    _KLICKY_ASSERT_OPEN
    {action_respond_info("KLICKY_ATTACH done (fallback)")}
  {% else %}
    {action_raise_error("KLICKY_ATTACH: UNKNOWN state: " ~ z)}
  {% endif %}

[gcode_macro KLICKY_ATTACH]
description: Pickup probe from dock
gcode:
  {% if ("x" not in printer.toolhead.homed_axes) or ("y" not in printer.toolhead.homed_axes) %}
    G28 X Y
  {% endif %}
  _KLICKY_FORCE_LIFT
  _KLICKY_ATTACH_ATTEMPT_PRIMARY
  _KLICKY_REFRESH_ENDSTOPS
  _KLICKY_ATTACH_VERIFY

[gcode_macro _KLICKY_DOCK_ATTEMPT]
gcode:
  {% set c = printer["gcode_macro KLICKY_CFG"] %}
  G90
  G0 X{c.approach_x} Y{c.approach_y} F{c.travel_f}
  G0 X{c.dock_x}     Y{c.dock_y}     F{c.travel_f}
  {% if (c.push_x|float != 0.0) or (c.push_y|float != 0.0) %}
    G0 X{(c.dock_x + c.push_x)|round(3)} Y{(c.dock_y + c.push_y)|round(3)} F{c.dock_f}
  {% endif %}
  G4 P{c.dwell_ms}
  G0 X{c.pull_x}     Y{c.pull_y}     F{c.dock_f}
  G4 P120
  G0 X{c.clear_x}    Y{c.clear_y}    F{c.dock_f}
  G0 X{c.approach_x} Y{c.approach_y} F{c.travel_f}
  M400
  G4 P120

[gcode_macro _KLICKY_DOCK_VERIFY_OR_RETRY]
gcode:
  _KLICKY_REFRESH_ENDSTOPS
  {% set z = (printer.query_endstops.last_query.z|default("unknown"))|string|lower %}

  {% if z in ["triggered","1","true"] %}
    {action_respond_info("KLICKY_DOCK: ok (probe docked)")}
  {% elif z in ["open","0","false"] %}
    {action_respond_info("KLICKY_DOCK: probe still attached -> retry once")}
    _KLICKY_DOCK_ATTEMPT
    _KLICKY_REFRESH_ENDSTOPS
    {% set z2 = (printer.query_endstops.last_query.z|default("unknown"))|string|lower %}
    {% if z2 in ["triggered","1","true"] %}
      {action_respond_info("KLICKY_DOCK: ok after retry")}
    {% else %}
      {action_raise_error("KLICKY_DOCK FAILED: probe still attached after 2 attempts. STOPPING PRINT.")}
    {% endif %}
  {% else %}
    {action_raise_error("KLICKY_DOCK: UNKNOWN probe state: " ~ z)}
  {% endif %}

[gcode_macro KLICKY_DOCK]
description: Dock probe (remove from head). Retry once, error if still attached.
gcode:
  {% if ("x" not in printer.toolhead.homed_axes) or ("y" not in printer.toolhead.homed_axes) %}
    G28 X Y
  {% endif %}
  _KLICKY_FORCE_LIFT
  _KLICKY_DOCK_ATTEMPT
  _KLICKY_DOCK_VERIFY_OR_RETRY

  
[gcode_macro _KLICKY_ATTACH_IF_NEEDED_DECIDE]
gcode:
  {% set z = (printer.query_endstops.last_query.z|default("unknown"))|string|lower %}
  {% if z in ["open","0","false"] %}
    {action_respond_info("KLICKY: already attached")}
  {% elif z in ["triggered","1","true"] %}
    {action_respond_info("KLICKY: missing -> attach from dock")}
    KLICKY_ATTACH
    _KLICKY_REFRESH_ENDSTOPS
    _KLICKY_ASSERT_OPEN
  {% else %}
    {action_raise_error("KLICKY: UNKNOWN probe state: " ~ z)}
  {% endif %}

[gcode_macro KLICKY_ATTACH_IF_NEEDED]
description: Attach probe only if it is missing/docked
gcode:
  _KLICKY_REFRESH_ENDSTOPS
  _KLICKY_ATTACH_IF_NEEDED_DECIDE

# =====================================================================
# HOMING OVERRIDE (Z)
# =====================================================================
[homing_override]
axes: z
set_position_z: 0
gcode:
  {action_respond_info("HOMING(Z): start")}
  G4 P300

  {% set probe_x = 122.5 %}
  {% set probe_y = 122.5 %}
  {% set xoff = printer.configfile.settings['probe'].x_offset|float %}
  {% set yoff = printer.configfile.settings['probe'].y_offset|float %}
  {% set zx = (probe_x - xoff) %}
  {% set zy = (probe_y - yoff) %}

  G91
  G1 Z2 F600
  G90
  
  G28 X Y

  KLICKY_ATTACH_IF_NEEDED
  _KLICKY_REFRESH_ENDSTOPS
  _KLICKY_ASSERT_OPEN

  G90
  G0 X{zx} Y{zy} F12000
  G28 Z

  Z_TILT_ADJUST
  G0 X{zx} Y{zy} F12000
  G28 Z
  
  G91
  G1 Z2 F600
  G90
  {action_respond_info("HOMING(Z): done")}



[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BED_MESH_CALIBRATE_BASE
gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}

  _KLICKY_FORCE_LIFT
  KLICKY_ATTACH_IF_NEEDED
  _KLICKY_REFRESH_ENDSTOPS
  _KLICKY_ASSERT_OPEN

  BED_MESH_CALIBRATE_BASE {rawparams}
  



[gcode_macro PROBE_CALIBRATE]
rename_existing: PROBE_CALIBRATE_BASE
description: Ensure XY homed + ensure Klicky attached, then run stock PROBE_CALIBRATE
gcode:
  {% if ("x" not in printer.toolhead.homed_axes) or ("y" not in printer.toolhead.homed_axes) %}
    G28 X Y
  {% endif %}

  KLICKY_ATTACH_IF_NEEDED
  _KLICKY_REFRESH_ENDSTOPS
  _KLICKY_ASSERT_OPEN

  {action_respond_info("PROBE_CALIBRATE: when it says 'manual Z probe', dock/remove Klicky manually, then use TESTZ, then ACCEPT + SAVE_CONFIG.")}

  PROBE_CALIBRATE_BASE {rawparams}


  
# =====================================================================
# TIMELAPSE (unchanged)
# =====================================================================

[gcode_macro GET_TIMELAPSE_SETUP]
description: Print the Timelapse setup
gcode: 
  {% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
  {% set output_txt = ["Timelapse Setup:"] %}
  {% set _dummy = output_txt.append("enable: %s" % tl.enable) %}
  {% set _dummy = output_txt.append("park: %s" % tl.park.enable) %}
  {% if tl.park.enable %}
    {% set _dummy = output_txt.append("park position: %s time: %s s" % (tl.park.pos, tl.park.time)) %}
    {% set _dummy = output_txt.append("park cord x:%s y:%s dz:%s" % (tl.park.coord.x, tl.park.coord.y, tl.park.coord.dz)) %}
    {% set _dummy = output_txt.append("travel speed: %s mm/s" % tl.speed.travel) %}
  {% endif %}
  {% set _dummy = output_txt.append("fw_retract: %s" % tl.extruder.fw_retract) %}
  {% if not tl.extruder.fw_retract %}
    {% set _dummy = output_txt.append("retract: %s mm speed: %s mm/s" % (tl.extruder.retract, tl.speed.retract)) %}
    {% set _dummy = output_txt.append("extrude: %s mm speed: %s mm/s" % (tl.extruder.extrude, tl.speed.extrude)) %}
  {% endif %}
  {% set _dummy = output_txt.append("verbose: %s" % tl.verbose) %}
  {action_respond_info(output_txt|join("\n"))}

[gcode_macro TIMELAPSE_TAKE_FRAME]
description: Take Timelapse shoot
variable_enable: False
variable_takingframe: False
variable_park: {'enable': False,
                'pos'   : 'center',
                'time'  : 0.1,
                'custom': {'x': 0, 'y': 0, 'dz': 0},
                'coord' : {'x': 0, 'y': 0, 'dz': 0}}
variable_extruder: {'fw_retract': False,
                    'retract': 1.0,
                    'extrude': 1.0}
variable_speed: {'travel': 100,
                 'retract': 15,
                 'extrude': 15}
variable_verbose: True
variable_check_time: 0.5
variable_restore: {'absolute': {'coordinates': True, 'extrude': True}, 'speed': 1500, 'e':0, 'factor': {'speed': 1.0, 'extrude': 1.0}}
variable_macro: {'pause': 'PAUSE', 'resume': 'RESUME'}
variable_is_paused: False
gcode:
  {% set hyperlapse = True if params.HYPERLAPSE and params.HYPERLAPSE|lower =='true' else False %}
  {% if enable %}
    {% if (hyperlapse and printer['gcode_macro HYPERLAPSE'].run) or
          (not hyperlapse and not printer['gcode_macro HYPERLAPSE'].run) %}
      {% if park.enable %}
        {% set pos = {'x': 'X' + park.coord.x|string if park.pos != 'y_only' else '', 
                      'y': 'Y' + park.coord.y|string if park.pos != 'x_only' else '', 
                      'z': 'Z'+ [printer.gcode_move.gcode_position.z + park.coord.dz, printer.toolhead.axis_maximum.z]|min|string} %}
        {% set restore = {'absolute': {'coordinates': printer.gcode_move.absolute_coordinates,
                                       'extrude'    : printer.gcode_move.absolute_extrude},
                          'speed'   : printer.gcode_move.speed,
                          'e'       : printer.gcode_move.gcode_position.e,
                          'factor'  : {'speed'  : printer.gcode_move.speed_factor,
                                       'extrude': printer.gcode_move.extrude_factor}} %}
        SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=restore VALUE="{restore}"
        {% if not printer[printer.toolhead.extruder].can_extrude %}
          {% if verbose %}{action_respond_info("Timelapse: Warning, minimum extruder temperature not reached!")}{% endif %}
        {% else %}
          {% if extruder.fw_retract %}
            G10
          {% else %}
            M83
            G0 E-{extruder.retract} F{speed.retract * 60}
          {% endif %}
        {% endif %}
        SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=is_paused VALUE=True 
        {macro.pause}
        SET_GCODE_OFFSET X=0 Y=0
        G90
        {% if "xyz" not in printer.toolhead.homed_axes %}
          {% if verbose %}{action_respond_info("Timelapse: Warning, axis not homed yet!")}{% endif %}
        {% else %}
          G0 {pos.x} {pos.y} {pos.z} F{speed.travel * 60}
        {% endif %}
        SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=takingframe VALUE=True
        UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_TAKE_FRAME DURATION={check_time}
        M400
      {% endif %}
      _TIMELAPSE_NEW_FRAME HYPERLAPSE={hyperlapse}
    {% endif %}    
  {% else %}
    {% if verbose %}{action_respond_info("Timelapse: disabled, take frame ignored")}{% endif %}
  {% endif %}

[gcode_macro _TIMELAPSE_NEW_FRAME]
description: action call for timelapse shoot. must be a seperate macro
gcode:  
 {action_call_remote_method("timelapse_newframe", 
                            macropark=printer['gcode_macro TIMELAPSE_TAKE_FRAME'].park, 
                            hyperlapse=params.HYPERLAPSE)}

[delayed_gcode _WAIT_TIMELAPSE_TAKE_FRAME]
gcode:
  {% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
  {% set factor = {'speed': printer.gcode_move.speed_factor, 'extrude': printer.gcode_move.extrude_factor} %}
  {% if tl.takingframe %}
    UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_TAKE_FRAME DURATION={tl.check_time}
  {% else %}
    {tl.macro.resume} VELOCITY={tl.speed.travel}
    SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=is_paused VALUE=False
    {% if not printer[printer.toolhead.extruder].can_extrude %}
        {action_respond_info("Timelapse: Warning minimum extruder temperature not reached!")}
    {% else %}
      {% if tl.extruder.fw_retract %}
        G11
      {% else %}
        G0 E{tl.extruder.extrude} F{tl.speed.extrude * 60}
        G0 F{tl.restore.speed}
        {% if tl.restore.absolute.extrude %} 
          M82
          G92 E{tl.restore.e}
        {% endif %}
      {% endif %}
    {% endif %}
    {% if tl.restore.factor.speed   != factor.speed   %} M220 S{(factor.speed*100)|round(0)}   {% endif %}
    {% if tl.restore.factor.extrude != factor.extrude %} M221 S{(factor.extrude*100)|round(0)} {% endif %}
    {% if not tl.restore.absolute.coordinates %} G91 {% endif %}
  {% endif %}

[delayed_gcode _HYPERLAPSE_LOOP]
gcode:
  UPDATE_DELAYED_GCODE ID=_HYPERLAPSE_LOOP DURATION={printer["gcode_macro HYPERLAPSE"].cycle}
  TIMELAPSE_TAKE_FRAME HYPERLAPSE=True

[gcode_macro TIMELAPSE_RENDER]
description: Render Timelapse video and wait for the result
variable_render: False
variable_run_identifier: 0
gcode:
  {action_respond_info("Timelapse: Rendering started")}
  {action_call_remote_method("timelapse_render", byrendermacro="True")}
  SET_GCODE_VARIABLE MACRO=TIMELAPSE_RENDER VARIABLE=render VALUE=True
  {printer.configfile.settings['gcode_macro pause'].rename_existing}
  UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_RENDER DURATION=0.5

[delayed_gcode _WAIT_TIMELAPSE_RENDER]
gcode:
  {% set ri = printer['gcode_macro TIMELAPSE_RENDER'].run_identifier % 4 %}
  SET_GCODE_VARIABLE MACRO=TIMELAPSE_RENDER VARIABLE=run_identifier VALUE={ri + 1}
  {% if printer['gcode_macro TIMELAPSE_RENDER'].render %}
    M117 Rendering {['-','\\','|','/'][ri]}
    UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_RENDER DURATION=0.5
  {% else %}
    {action_respond_info("Timelapse: Rendering finished")}
    M117
    {printer.configfile.settings['gcode_macro resume'].rename_existing}
  {% endif %}

[gcode_macro TEST_STREAM_DELAY]
description: Helper macro to find stream and park delay
gcode:
  {% set min = printer.toolhead.axis_minimum %}
  {% set max = printer.toolhead.axis_maximum %}
  {% set act = printer.toolhead.position %}
  {% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
  {% if act.z > 5.0 %}
    G0 X{min.x + 5.0} F{tl.speed.travel|int * 60}
    G0 X{(max.x-min.x)/2}
    G4 P{tl.park.time|float * 1000}
    _TIMELAPSE_NEW_FRAME HYPERLAPSE=FALSE
    G0 X{max.x - 5.0}
  {% else %}
    {action_raise_error("Toolhead z %.3f to low. Please place head above z = 5.0" % act.z)}
  {% endif %}


[gcode_macro LOG_Z]
description: Print current Z position and configured probe z_offset
gcode:
  {% set zpos = printer.toolhead.position.z|float %}
  {% set zoff = printer.configfile.settings['probe'].z_offset|default(0.0)|float %}
  {action_respond_info("Zpos=%.3f z_offset=%.3f" % (zpos, zoff))}

[gcode_macro PRINT_START]
description: Wait bed (no moves) -> Home via G28 Z (override) -> Mesh -> Dock -> Park front for cleaning -> Hotend final
gcode:
  {% set bed = params.BED_TEMP|default(60)|float %}
  {% set hotend = params.EXTRUDER_TEMP|default(200)|float %}
  {% set do_mesh = params.MESH|default(1)|int %}
  {% set hotend_hold = params.HOTEND_HOLD|default(150)|float %}
  {% set chamber = params.CHAMBER_TEMP|default(0)|float %}

  {% set park_x = params.PARK_X|default(123)|float %}
  {% set park_y = params.PARK_Y|default(5)|float %}
  {% set park_z = params.PARK_Z|default(10)|float %}

  RESPOND MSG="PRINT_START: bed={bed|round(1)} hotend={hotend|round(1)} hold={hotend_hold|round(0)} chamber={chamber|round(0)} mesh={do_mesh}"

  G90
  M107

  M140 S{bed}
  M104 S{hotend_hold}
  {% if chamber|float > 0 %}
    SET_HEATER_TEMPERATURE HEATER=chamber TARGET={chamber}
  {% endif %}

  M190 S{bed}

  G28 Z

  {% if do_mesh == 1 %}
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE
  {% endif %}

  KLICKY_DOCK

  M104 S{hotend}

  G91
  G1 Z15 F600
  G90

  G0 X{park_x} Y{park_y} F6000

  M109 S{hotend}

  

[gcode_macro PRINT_END]
description: End print (park, cool, pickup probe)
gcode:
  M107
  {% if "xyz" in printer.toolhead.homed_axes %}
    G91
    G1 Z10 F600
    G90
    G1 X30 Y30 F6000
  {% endif %}

  TURN_OFF_HEATERS
  BED_MESH_CLEAR

  {% if ("x" in printer.toolhead.homed_axes) and ("y" in printer.toolhead.homed_axes) %}
    KLICKY_ATTACH_IF_NEEDED
  {% endif %}

  M84
  {action_respond_info("PRINT_END complete")}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 0.000
#*#
#*# [adxl345]
#*# probe_pin = gpio9
#*# int_pin = int1
#*# tap_thresh = 3500
#*# tap_dur = 0.01
#*# speed = 20
#*# z_offset = 1.75
#*# samples = 3
#*# sample_retract_dist = 10.0
#*# samples_result = median
#*# samples_tolerance = 0.05
#*# samples_tolerance_retries = 3
